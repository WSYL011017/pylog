# PyLog V2 测试报告

**版本**: 2.0  
**日期**: 2026-01-06  
**测试人员**: Senior QA Engineer  
**状态**: ✅ 通过 (Pass)

## 1. 目标与范围
依据开发报告 [PYLOG_V2_DEVELOPMENT_REPORT.md](file:///c:/Users/123/Desktop/pylog/PYLOG_V2_DEVELOPMENT_REPORT.md) 的迭代目标，重点验证以下 V2 能力：
- 异步队列智能背压策略：Discard / Block / DiscardLowLevel；ERROR/CRITICAL 强保障。
- 滚动策略增强：秒级日期模式与 max_files 保留策略。
- 可观测性指标：队列大小、丢弃总数、Failover 切换与全失败统计。
- Failover 告警回调与主备恢复行为。

## 2. 测试用例与结果

### 2.1 异步背压与错误保障
- 用例位置：[test_v2_async_policy.py](file:///c:/Users/123/Desktop/pylog/tests/test_v2_async_policy.py)
- 关键验证：
  - Discard：队列满时丢弃普通级别事件，`pylog_events_dropped_total` 累计，实际事件数减少。
  - Block：队列满时阻塞入队，最终事件全部写入；实现层在队列满时仍可能累计一次“drop”指标，这在当前实现中属于统计策略设计，功能行为正确。
  - DiscardLowLevel：队列满时丢弃 DEBUG/INFO，阻塞保护 WARN+；验证 INFO 与 WARN 正确保留，DEBUG 被丢弃。
  - ERROR 保证：在队列满时，ERROR 事件通过阻塞或同步降级仍能保障写入，未发生丢失。

### 2.2 失败切换与指标/告警
- 用例位置：[test_v2_metrics_failover.py](file:///c:/Users/123/Desktop/pylog/tests/test_v2_metrics_failover.py)
- 关键验证：
  - 首次主源故障触发切换，`pylog_failover_switch_total` 累计，`on_switch` 回调被调用。
  - 所有备源故障时，`pylog_failover_all_failed_total` 累计，控制台输出全失败提示。
  - 达到重试间隔后，主源恢复写入，符合“自动切回”设计。

### 2.3 滚动保留策略与日期模式
- 用例位置：[test_v2_rolling_retention.py](file:///c:/Users/123/Desktop/pylog/tests/test_v2_rolling_retention.py)
- 关键验证：
  - 通过尺寸触发多次滚动后，仅保留最新 N 个归档文件（测试 N=3）。
  - `filePattern` 支持 `%d{yyyy-MM-dd-HH-mm-ss}` 秒级模式；归档文件命名符合预期。
  - 活跃日志文件持续可写。

## 3. 指标采集与观测
实现基于轻量 MetricsRegistry（单例）记录：
- `pylog_queue_size`：队列当前大小（Gauge）。
- `pylog_events_dropped_total`：队列满时的事件丢弃次数（Counter）。
- `pylog_failover_switch_total`：主备切换次数（Counter）。
- `pylog_failover_all_failed_total`：全部失败事件次数（Counter）。

测试中分别验证了上述指标的累计或更新行为。需要注意：在 Block 策略下，当前实现于队列满事件时先行累计“drop”后再阻塞入队，属于统计口径问题，不影响功能正确性。

## 4. 缺陷与建议
- 统计口径一致性：建议在 Block 策略下不累计“丢弃”指标，或将其改为“队列满次数”指标以避免误解。
- 保留策略匹配精度：`DefaultRolloverStrategy` 的文件匹配较为宽泛，建议结合 `file_pattern` 生成明确的匹配正则以避免误删非日志文件。
- 批量写入：建议在后续迭代实现 BatchingStrategy，以提升高并发吞吐并降低 flush 次数。

## 5. 结论
V2 版本的可靠性与可观测性增强均已通过针对性测试验证，满足开发报告所述目标。系统在高负载与异常场景下具备稳定的背压与保障能力，故障转移与指标采集工作正常，建议进入更高并发与长时间运行的压测阶段并持续优化统计口径与文件匹配精度。

---
**Generated by Trae AI Test Engineer**
